name: Deploy to EC2 via SSM

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    - name: Deploy via AWS SSM
      id: ssm-command
      run: |
        echo "üöÄ Starting deployment..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
          --document-name "AWS-RunShellScript" \
          --comment "Deploy from GitHub Actions - $(date)" \
          --timeout-seconds 600 \
          --parameters commands='[
            "#!/bin/bash",
            "set -e",
            "echo \"========================================\"",
            "echo \"üöÄ Starting Deployment\"",
            "echo \"========================================\"",
            "echo \"\"",
            "sudo -i -u ubuntu bash << '\''EOF'\''",
            "set -e",
            "export NVM_DIR=\"$HOME/.nvm\"",
            "[ -s \"$NVM_DIR/nvm.sh\" ] && . \"$NVM_DIR/nvm.sh\"",
            "[ -s \"$HOME/.bashrc\" ] && . \"$HOME/.bashrc\"",
            "echo \"‚úì Environment loaded (node: $(node --version), npm: $(npm --version))\"",
            "cd /home/ubuntu/constructionCRM || { echo \"‚ùå Failed to cd to project\"; exit 1; }",
            "echo \"‚úì In project directory: $(pwd)\"",
            "echo \"\"",
            "echo \"üì• Updating code from GitHub...\"",
            "git fetch origin main || { echo \"‚ùå Git fetch failed\"; exit 1; }",
            "git reset --hard origin/main || { echo \"‚ùå Git reset failed\"; exit 1; }",
            "echo \"‚úì Code updated to: $(git rev-parse --short HEAD)\"",
            "echo \"\"",
            "echo \"üì¶ Installing backend dependencies...\"",
            "npm install --omit=dev 2>&1 | grep -v \"baseline-browser-mapping\" || true",
            "echo \"‚úì Backend dependencies installed\"",
            "echo \"\"",
            "echo \"üîÑ Managing backend API process...\"",
            "pm2 delete construction-crm-api 2>/dev/null || echo \"  (No existing process to delete)\"",
            "pm2 start server.js --name construction-crm-api || { echo \"‚ùå PM2 start failed\"; exit 1; }",
            "pm2 save",
            "echo \"‚úì Backend API started\"",
            "echo \"\"",
            "echo \"üé® Building frontend...\"",
            "cd inventory-frontend || { echo \"‚ùå Failed to cd to frontend\"; exit 1; }",
            "npm install 2>&1 | grep -v \"baseline-browser-mapping\" || true",
            "echo \"  Dependencies installed\"",
            "REACT_APP_API_URL=https://www.beamliner.com npm run build || { echo \"‚ùå Frontend build failed\"; exit 1; }",
            "echo \"‚úì Frontend built successfully\"",
            "echo \"\"",
            "echo \"‚úÖ Application updated successfully!\"",
            "EOF",
            "EXIT_CODE=$?",
            "if [ $EXIT_CODE -ne 0 ]; then",
            "  echo \"‚ùå Deployment failed with exit code: $EXIT_CODE\"",
            "  exit $EXIT_CODE",
            "fi",
            "echo \"\"",
            "echo \"üîÑ Restarting nginx...\"",
            "sudo systemctl restart nginx || { echo \"‚ùå Nginx restart failed\"; exit 1; }",
            "echo \"‚úì Nginx restarted\"",
            "echo \"\"",
            "echo \"========================================\"",
            "echo \"‚úÖ Deployment Complete!\"",
            "echo \"========================================\""
          ]' \
          --output text \
          --query "Command.CommandId")
        
        echo "üìù Command ID: $COMMAND_ID"
        echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
        
        # Wait for command to complete
        echo "‚è≥ Waiting for deployment to complete..."
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "${{ secrets.EC2_INSTANCE_ID }}"
        
        echo "‚úÖ Deployment finished!"
    
    - name: Get Deployment Output
      if: always()
      run: |
        echo "üìã Full Deployment Output:"
        echo "================================"
        
        STATUS=$(aws ssm get-command-invocation \
          --command-id "${{ steps.ssm-command.outputs.command_id }}" \
          --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
          --query "Status" \
          --output text)
        
        echo "Status: $STATUS"
        echo ""
        echo "Standard Output:"
        echo "----------------"
        aws ssm get-command-invocation \
          --command-id "${{ steps.ssm-command.outputs.command_id }}" \
          --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
          --query "StandardOutputContent" \
          --output text
        
        echo ""
        echo "Standard Error:"
        echo "---------------"
        aws ssm get-command-invocation \
          --command-id "${{ steps.ssm-command.outputs.command_id }}" \
          --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
          --query "StandardErrorContent" \
          --output text
        
        if [ "$STATUS" != "Success" ]; then
          echo ""
          echo "‚ùå Deployment failed with status: $STATUS"
          exit 1
        else
          echo ""
          echo "‚úÖ Deployment completed successfully!"
        fi

