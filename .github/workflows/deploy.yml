name: Deploy to EC2 via SSM

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    - name: Deploy via AWS SSM
      id: ssm-command
      run: |
        echo "üöÄ Starting deployment..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
          --document-name "AWS-RunShellScript" \
          --comment "Deploy from GitHub Actions - $(date)" \
          --timeout-seconds 600 \
          --parameters commands='[
            "#!/bin/bash",
            "set -e",
            "echo \"üöÄ Starting deployment as ubuntu user...\"",
            "sudo -i -u ubuntu bash << '\''EOF'\''",
            "cd /home/ubuntu/constructionCRM",
            "echo \"üìÇ In project directory\"",
            "echo \"‚¨áÔ∏è  Pulling latest code from GitHub...\"",
            "git fetch origin main",
            "git reset --hard origin/main",
            "echo \"üì¶ Installing backend dependencies...\"",
            "npm install --production",
            "echo \"üîÑ Restarting backend API...\"",
            "pm2 restart construction-crm-api || pm2 start server.js --name construction-crm-api",
            "echo \"üìÇ Building frontend...\"",
            "cd inventory-frontend",
            "npm install",
            "REACT_APP_API_URL=https://www.beamliner.com npm run build",
            "echo \"‚úÖ Backend and frontend updated!\"",
            "EOF",
            "echo \"üîÑ Restarting nginx...\"",
            "sudo systemctl restart nginx",
            "echo \"‚úÖ Deployment complete!\""
          ]' \
          --output text \
          --query "Command.CommandId")
        
        echo "üìù Command ID: $COMMAND_ID"
        echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
        
        # Wait for command to complete
        echo "‚è≥ Waiting for deployment to complete..."
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "${{ secrets.EC2_INSTANCE_ID }}"
        
        echo "‚úÖ Deployment finished!"
    
    - name: Get Deployment Output
      if: always()
      run: |
        echo "üìã Deployment Output:"
        echo "===================="
        aws ssm get-command-invocation \
          --command-id "${{ steps.ssm-command.outputs.command_id }}" \
          --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
          --query "StandardOutputContent" \
          --output text
    
    - name: Check for Errors
      if: always()
      run: |
        ERROR_OUTPUT=$(aws ssm get-command-invocation \
          --command-id "${{ steps.ssm-command.outputs.command_id }}" \
          --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
          --query "StandardErrorContent" \
          --output text)
        
        if [ ! -z "$ERROR_OUTPUT" ] && [ "$ERROR_OUTPUT" != "None" ]; then
          echo "‚ö†Ô∏è  Errors detected:"
          echo "===================="
          echo "$ERROR_OUTPUT"
          exit 1
        else
          echo "‚úÖ No errors detected"
        fi

